# 502 Bad Gateway - Step-by-Step Fix

## What's Happening
Nginx (your web server) can't connect to Flask (your app). This means **Flask isn't running**.

## Quick Fix (5 Steps)

### Step 1: Upload the New Files
Upload these files to `/root/montanablotter/` on your VPS:
- `app_updated.py` → Rename to `app.py` (replace your old one)
- `init_db.py`
- `pdf_parser.py`
- `processor.py`
- `config.py`
- `email_worker.py`
- `seed_admin.py`

**Keep your existing `templates/` folder - don't touch it!**

### Step 2: SSH into Your VPS
```bash
ssh root@your-server-ip
cd /root/montanablotter
```

### Step 3: Initialize Database
```bash
# Create database and tables
python3 init_db.py

# Create admin user
python3 seed_admin.py
```

**You should see:**
```
✅ Database initialized successfully!
✅ Admin user created
  Username: admin
  Password: Blotter2026!
```

### Step 4: Start Flask
```bash
# Stop any old processes
pkill -f app.py
pkill -f gunicorn

# Start Flask (port 5000 for testing)
python3 app.py
```

**You should see:**
```
 * Serving Flask app 'app'
 * Debug mode: on
 * Running on http://0.0.0.0:5000
```

**Leave this terminal open!**

### Step 5: Test in Browser
Open a new browser tab:
```
http://your-server-ip:5000
```

You should see your Montana Blotter landing page!

---

## If It Works on Port 5000

Your Flask app is working! Now connect it to nginx on port 80.

### Option A: Update Nginx Config

```bash
# In a NEW terminal window
sudo nano /etc/nginx/sites-available/montanablotter.com
```

**Make sure it has:**
```nginx
server {
    listen 80;
    server_name montanablotter.com www.montanablotter.com;
    
    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

**Then:**
```bash
# Test nginx config
sudo nginx -t

# Reload nginx
sudo systemctl reload nginx
```

Now visit `http://montanablotter.com` - it should work!

---

## If You Get Errors

### Error: "No module named 'config'"
```bash
cd /root/montanablotter
ls -l config.py  # Make sure it exists

# If missing, upload config.py
```

### Error: "no such table: users"
```bash
# Reinitialize database
python3 init_db.py
```

### Error: "Address already in use"
```bash
# Something else is on port 5000
# Kill it:
pkill -f app.py
pkill -f gunicorn

# Try again:
python3 app.py
```

### Error: Import errors
```bash
# Test what's failing:
python3 -c "import app"

# Usually means missing files. Check:
ls -l *.py
# Should see: app.py, config.py, processor.py, pdf_parser.py, etc.
```

---

## Production Setup (After It Works)

Once it works on port 5000, set up systemd so it runs permanently:

```bash
# Create service file
sudo nano /etc/systemd/system/montanablotter.service
```

**Paste:**
```ini
[Unit]
Description=Montana Blotter
After=network.target

[Service]
User=root
WorkingDirectory=/root/montanablotter
ExecStart=/usr/bin/python3 app.py
Restart=always

[Install]
WantedBy=multi-user.target
```

**Enable:**
```bash
sudo systemctl daemon-reload
sudo systemctl enable montanablotter
sudo systemctl start montanablotter
sudo systemctl status montanablotter
```

Now it will:
- Start automatically on boot
- Restart if it crashes
- Run in the background

---

## Still Getting 502?

Run the diagnostic:
```bash
bash diagnose_502.sh
```

Or check manually:
```bash
# 1. Is Flask running?
ps aux | grep app.py

# 2. Is it on port 5000?
netstat -tlnp | grep :5000

# 3. Check nginx logs
tail -20 /var/log/nginx/error.log

# 4. Test Flask directly
curl http://127.0.0.1:5000
# Should return HTML, not error
```

---

## Key Points

1. **502 = Flask not running** (most common)
2. **Test on port 5000 first** before worrying about nginx
3. **Don't touch your templates** - they're perfect!
4. **Database must exist** - run `init_db.py` first
5. **Watch for import errors** - missing files will crash Flask

---

## Login Info

After everything works:
- **URL:** http://montanablotter.com or http://your-ip:5000
- **Username:** admin
- **Password:** Blotter2026!

Change the password in `/admin` after logging in!
