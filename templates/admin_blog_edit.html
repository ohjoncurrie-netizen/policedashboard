{% extends "base.html" %}

{% block content %}
<!-- EasyMDE markdown editor -->
<link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
<script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>

<div class="max-w-4xl mx-auto">

    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">
                {% if post %}Edit Post{% else %}New Post{% endif %}
            </h1>
            <p class="text-sm text-gray-500 mt-1">
                {% if post %}Last updated: {{ post.updated_at[:10] if post.updated_at else '—' }}{% else %}Write in Markdown — preview on the right{% endif %}
            </p>
        </div>
        <a href="/admin/blog" class="text-sm text-gray-500 hover:text-gray-900 font-semibold">
            <i class="fas fa-arrow-left mr-1"></i> Back to Blog
        </a>
    </div>

    <!-- Flash errors -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
        <div class="mb-4 px-4 py-3 rounded-lg text-sm font-medium
            {% if category == 'error' %}bg-red-50 text-red-700 border border-red-200
            {% else %}bg-green-50 text-green-700 border border-green-200{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    {% endif %}
    {% endwith %}

    <form method="POST" class="space-y-5">

        <!-- Title -->
        <div>
            <label class="block text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1">Title <span class="text-red-500">*</span></label>
            <input type="text" name="title" required
                   value="{{ form.title or '' }}"
                   placeholder="e.g. What Montana's New Records Law Means for You"
                   class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <!-- Slug -->
        <div>
            <label class="block text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1">
                URL Slug
                <span class="normal-case font-normal text-gray-400 ml-1">(auto-generated from title if blank)</span>
            </label>
            <div class="flex items-center border border-gray-300 rounded-lg overflow-hidden focus-within:ring-2 focus-within:ring-blue-500">
                <span class="px-3 py-2.5 bg-gray-50 text-gray-400 text-sm border-r border-gray-300 select-none">/blog/</span>
                <input type="text" name="slug"
                       value="{{ form.slug or '' }}"
                       placeholder="my-post-slug"
                       class="flex-1 px-3 py-2.5 text-sm focus:outline-none font-mono">
            </div>
        </div>

        <!-- Excerpt -->
        <div>
            <label class="block text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1">
                Excerpt
                <span class="normal-case font-normal text-gray-400 ml-1">(short summary shown on blog listing)</span>
            </label>
            <textarea name="excerpt" rows="2"
                      placeholder="A short teaser sentence or two..."
                      class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none">{{ form.excerpt or '' }}</textarea>
        </div>

        <!-- Author -->
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1">Author</label>
                <input type="text" name="author"
                       value="{{ form.author or 'Montana Blotter' }}"
                       class="w-full border border-gray-300 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex items-end">
                <label class="flex items-center gap-3 cursor-pointer p-3 border border-gray-300 rounded-lg w-full hover:bg-gray-50 transition">
                    <input type="checkbox" name="published" value="1"
                           {% if form and form.published %}checked{% endif %}
                           class="w-4 h-4 accent-blue-600">
                    <div>
                        <p class="text-sm font-semibold text-gray-800">Publish</p>
                        <p class="text-xs text-gray-400">Make visible to the public</p>
                    </div>
                </label>
            </div>
        </div>

        <!-- Body (Markdown) -->
        <div>
            <label class="block text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1">
                Body <span class="text-red-500">*</span>
                <span class="normal-case font-normal text-gray-400 ml-1">(Markdown supported)</span>
            </label>
            <textarea id="body-editor" name="body">{{ form.body or '' }}</textarea>
        </div>

        <!-- Actions -->
        <div class="flex items-center gap-3 pt-2 pb-8">
            <button type="submit"
                    class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold px-6 py-2.5 rounded-lg transition">
                {% if post %}<i class="fas fa-save mr-1.5"></i>Save Changes
                {% else %}<i class="fas fa-paper-plane mr-1.5"></i>Create Post{% endif %}
            </button>
            <a href="/admin/blog"
               class="text-sm text-gray-500 hover:text-gray-800 font-semibold px-4 py-2.5 rounded-lg border border-gray-300 hover:bg-gray-50 transition">
                Cancel
            </a>
            {% if post and post.published %}
            <a href="/blog/{{ post.slug }}" target="_blank"
               class="ml-auto text-sm text-emerald-600 hover:text-emerald-700 font-semibold flex items-center gap-1.5">
                <i class="fas fa-external-link-alt text-xs"></i> View Live Post
            </a>
            {% endif %}
        </div>

    </form>
</div>

<script>
const easyMDE = new EasyMDE({
    element: document.getElementById('body-editor'),
    spellChecker: false,
    autosave: {
        enabled: true,
        uniqueId: 'blog-editor-{{ post.id if post else "new" }}',
        delay: 3000,
    },
    toolbar: [
        'bold', 'italic', 'heading', '|',
        'quote', 'unordered-list', 'ordered-list', '|',
        'link', 'image', '|',
        'preview', 'side-by-side', 'fullscreen', '|',
        'guide'
    ],
    placeholder: 'Write your post in Markdown...\n\n## Section Heading\n\nYour paragraph here.',
    minHeight: '400px',
    status: ['autosave', 'lines', 'words'],
});
</script>
{% endblock %}
