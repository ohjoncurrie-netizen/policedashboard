<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <title>Montana Blotter | Public Safety Records</title>
</head>
<body class="bg-slate-50 font-sans text-slate-900">

    <!-- Navbar -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-slate-900 text-white p-2.5 rounded-xl">
                    <i class="fas fa-mountain"></i>
                </div>
                <div>
                    <h1 class="font-black uppercase italic tracking-tighter text-xl">Montana Blotter</h1>
                    <p class="text-[9px] text-slate-400 uppercase tracking-widest font-bold">Free Public Records</p>
                </div>
            </div>
            <div class="flex items-center gap-6">
                <a href="/posts" class="text-xs text-slate-500 hover:text-slate-900 font-bold uppercase tracking-widest">
                    Archive
                </a>
                <a href="/admin/login" class="text-xs text-slate-400 hover:text-slate-900 font-bold uppercase tracking-widest">
                    Admin
                </a>
            </div>
        </div>
    </nav>

    <!-- Hero -->
    <section class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white py-10 px-6">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row md:items-center md:justify-between gap-6">
            <div>
                <span class="inline-block bg-blue-500/20 text-blue-300 text-[10px] font-black px-3 py-1 rounded-full uppercase tracking-widest mb-3">
                    Open Source &bull; Free Forever
                </span>
                <h2 class="text-3xl md:text-4xl font-black tracking-tight leading-tight">
                    Montana Daily Activity Reports.<br/>
                    <span class="text-blue-400 italic">Transparent &amp; Accessible.</span>
                </h2>
                <p class="text-slate-300 text-sm mt-2 max-w-lg">
                    AI-summarized police blotters from Montana law enforcement agencies. No account required.
                </p>
            </div>
            <div class="flex gap-6 text-center flex-shrink-0">
                <div class="bg-white/10 rounded-2xl px-6 py-4">
                    <p class="text-2xl font-black">{{ total_records }}</p>
                    <p class="text-[10px] text-slate-400 uppercase tracking-widest font-bold mt-1">Raw Records</p>
                </div>
                <div class="bg-white/10 rounded-2xl px-6 py-4">
                    <p class="text-2xl font-black">{{ counties|length }}</p>
                    <p class="text-[10px] text-slate-400 uppercase tracking-widest font-bold mt-1">Counties</p>
                </div>
                <div class="bg-white/10 rounded-2xl px-6 py-4">
                    <p class="text-2xl font-black">{{ total }}</p>
                    <p class="text-[10px] text-slate-400 uppercase tracking-widest font-bold mt-1">Reports</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Main layout -->
    <div class="max-w-7xl mx-auto px-6 py-8 flex gap-8 items-start">

        <!-- ===== SIDEBAR ===== -->
        <aside class="w-64 flex-shrink-0 space-y-5 sticky top-24">

            <!-- Calendar -->
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-4">
                <div class="flex items-center justify-between mb-3">
                    <button id="cal-prev" class="w-7 h-7 flex items-center justify-center rounded hover:bg-slate-100 text-slate-500 transition">
                        <i class="fas fa-chevron-left text-xs"></i>
                    </button>
                    <span id="cal-title" class="text-sm font-bold text-slate-800"></span>
                    <button id="cal-next" class="w-7 h-7 flex items-center justify-center rounded hover:bg-slate-100 text-slate-500 transition">
                        <i class="fas fa-chevron-right text-xs"></i>
                    </button>
                </div>
                <!-- Day headers -->
                <div class="grid grid-cols-7 mb-1">
                    {% for d in ['S','M','T','W','T','F','S'] %}
                    <div class="text-center text-[10px] font-bold text-slate-400 py-1">{{ d }}</div>
                    {% endfor %}
                </div>
                <!-- Day grid -->
                <div id="cal-grid" class="grid grid-cols-7 gap-y-0.5"></div>
                {% if date_filter %}
                <a href="/?county={{ county }}&city={{ city }}&agency_type={{ agency_type }}&q={{ q }}"
                   class="block mt-3 text-center text-xs text-slate-400 hover:text-slate-700">
                    <i class="fas fa-times mr-1"></i>Clear date
                </a>
                {% endif %}
            </div>

            <!-- Filters -->
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-4">
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">Filters</h3>
                <form method="GET" action="/" class="space-y-3" id="filter-form">
                    <!-- preserve date if set -->
                    {% if date_filter %}
                    <input type="hidden" name="date" value="{{ date_filter }}">
                    {% endif %}

                    <div>
                        <label class="block text-xs font-semibold text-slate-600 mb-1">Search</label>
                        <input type="text" name="q" value="{{ q }}"
                               placeholder="keyword..."
                               class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label class="block text-xs font-semibold text-slate-600 mb-1">County</label>
                        <select name="county" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Counties</option>
                            {% for c in counties %}
                            <option value="{{ c }}" {% if c == county %}selected{% endif %}>{{ c }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-semibold text-slate-600 mb-1">City</label>
                        <select name="city" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Cities</option>
                            {% for c in cities %}
                            <option value="{{ c }}" {% if c == city %}selected{% endif %}>{{ c }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-semibold text-slate-600 mb-1">Agency Type</label>
                        <select name="agency_type" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All</option>
                            <option value="sheriff" {% if agency_type == 'sheriff' %}selected{% endif %}>Sheriff</option>
                            <option value="police"  {% if agency_type == 'police'  %}selected{% endif %}>Police</option>
                            <option value="other"   {% if agency_type == 'other'   %}selected{% endif %}>Other</option>
                        </select>
                    </div>

                    <button type="submit"
                            class="w-full bg-slate-900 hover:bg-blue-600 text-white text-sm font-bold py-2 rounded-lg transition">
                        Apply Filters
                    </button>

                    {% if county or city or agency_type or q or date_filter %}
                    <a href="/" class="block text-center text-xs text-slate-400 hover:text-slate-700">
                        Clear all filters
                    </a>
                    {% endif %}
                </form>
            </div>
        </aside>

        <!-- ===== FEED ===== -->
        <div class="flex-1 min-w-0 space-y-6">

            <!-- Active filters banner -->
            {% if date_filter or county or city or agency_type or q %}
            <div class="flex flex-wrap items-center gap-2 text-xs">
                <span class="text-slate-500 font-semibold">Filtered by:</span>
                {% if date_filter %}
                <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-medium">
                    <i class="fas fa-calendar-alt mr-1"></i>{{ date_filter }}
                </span>
                {% endif %}
                {% if county %}
                <span class="bg-slate-100 text-slate-700 px-2 py-1 rounded-full font-medium">{{ county }} County</span>
                {% endif %}
                {% if city %}
                <span class="bg-slate-100 text-slate-700 px-2 py-1 rounded-full font-medium">{{ city }}</span>
                {% endif %}
                {% if agency_type %}
                <span class="bg-slate-100 text-slate-700 px-2 py-1 rounded-full font-medium capitalize">{{ agency_type }}</span>
                {% endif %}
                {% if q %}
                <span class="bg-slate-100 text-slate-700 px-2 py-1 rounded-full font-medium">&ldquo;{{ q }}&rdquo;</span>
                {% endif %}
            </div>
            {% endif %}

            {% if posts %}
                {% for post in posts %}
                <article class="bg-white rounded-2xl border border-slate-100 shadow-sm p-6 hover:shadow-md transition">

                    <!-- Header row -->
                    <div class="flex items-start justify-between gap-3 mb-3">
                        <h2 class="text-xl font-black text-slate-900 leading-snug">
                            {{ post.title or 'Daily Activity Report' }}
                        </h2>
                        {% if post.agency_type == 'sheriff' %}
                        <span class="flex-shrink-0 inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-bold bg-blue-100 text-blue-800">
                            <i class="fas fa-star text-[10px]"></i>Sheriff
                        </span>
                        {% elif post.agency_type == 'police' %}
                        <span class="flex-shrink-0 inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-bold bg-red-100 text-red-800">
                            <i class="fas fa-shield-alt text-[10px]"></i>Police
                        </span>
                        {% else %}
                        <span class="flex-shrink-0 inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-bold bg-slate-100 text-slate-600">
                            Agency
                        </span>
                        {% endif %}
                    </div>

                    <!-- Meta -->
                    <div class="flex flex-wrap gap-x-4 gap-y-1 text-xs text-slate-500 mb-4">
                        {% if post.incident_date %}
                        <span><i class="fas fa-calendar-alt mr-1"></i>{{ post.incident_date }}</span>
                        {% endif %}
                        {% if post.county %}
                        <span><i class="fas fa-map-marker-alt mr-1"></i>{{ post.county }} County</span>
                        {% endif %}
                        {% if post.city %}
                        <span><i class="fas fa-city mr-1"></i>{{ post.city }}</span>
                        {% endif %}
                        {% if post.agency_name %}
                        <span><i class="fas fa-building mr-1"></i>{{ post.agency_name }}</span>
                        {% endif %}
                    </div>

                    <!-- Digest body -->
                    <div class="text-slate-700 text-sm leading-relaxed space-y-1">
                        {% for line in (post.summary or '').split('\n') %}
                            {% if line.strip() %}
                                {% if loop.first %}
                                <p class="font-semibold text-slate-800">{{ line }}</p>
                                {% else %}
                                <p>{{ line }}</p>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    </div>
                </article>
                {% endfor %}

                <!-- Pagination -->
                {% if total_pages > 1 %}
                <nav class="flex items-center justify-between pt-2 pb-8">
                    <p class="text-sm text-slate-500">Page {{ page }} of {{ total_pages }}</p>
                    <div class="flex gap-2">
                        {% if page > 1 %}
                        <a href="?county={{ county }}&city={{ city }}&agency_type={{ agency_type }}&q={{ q }}&date={{ date_filter }}&page={{ page - 1 }}"
                           class="px-4 py-2 border border-slate-300 rounded-lg text-sm hover:bg-slate-50 font-medium">&larr; Prev</a>
                        {% endif %}
                        {% if page < total_pages %}
                        <a href="?county={{ county }}&city={{ city }}&agency_type={{ agency_type }}&q={{ q }}&date={{ date_filter }}&page={{ page + 1 }}"
                           class="px-4 py-2 border border-slate-300 rounded-lg text-sm hover:bg-slate-50 font-medium">Next &rarr;</a>
                        {% endif %}
                    </div>
                </nav>
                {% endif %}

            {% else %}
                <div class="bg-white rounded-2xl border border-slate-100 p-16 text-center">
                    <i class="fas fa-newspaper text-slate-200 text-5xl mb-4 block"></i>
                    <h3 class="text-xl font-black text-slate-700 mb-2">No reports found</h3>
                    <p class="text-slate-400 text-sm mb-5">
                        {% if date_filter or county or city or agency_type or q %}
                            Try adjusting your filters or selecting a different date.
                        {% else %}
                            Reports are generated automatically when blotters are processed.
                        {% endif %}
                    </p>
                    {% if date_filter or county or city or agency_type or q %}
                    <a href="/" class="inline-block bg-slate-900 text-white px-6 py-2.5 rounded-xl text-sm font-bold hover:bg-blue-600 transition">
                        Clear filters
                    </a>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-slate-900 text-white py-10 mt-8">
        <div class="max-w-7xl mx-auto px-6 flex flex-col md:flex-row md:justify-between gap-6">
            <div>
                <h4 class="font-black text-base mb-2">Montana Blotter</h4>
                <p class="text-slate-400 text-sm max-w-xs leading-relaxed">
                    Free, open-source aggregation of Montana law enforcement blotters. Public safety information for everyone.
                </p>
            </div>
            <div class="text-slate-500 text-xs uppercase tracking-widest font-bold self-end">
                &copy; 2026 Montana Blotter &bull; Free Public Records
            </div>
        </div>
    </footer>

    <!-- ===== CALENDAR SCRIPT ===== -->
    <script>
    (function () {
        const datesWithPosts = new Set({{ dates_with_posts | tojson }});
        const selectedDate   = {{ date_filter | tojson }};
        const monthNames     = ['January','February','March','April','May','June',
                                'July','August','September','October','November','December'];

        // Start at selected date's month, or today
        let viewDate = selectedDate ? new Date(selectedDate + 'T12:00:00') : new Date();
        let viewYear  = viewDate.getFullYear();
        let viewMonth = viewDate.getMonth(); // 0-based

        function pad(n) { return String(n).padStart(2, '0'); }

        function buildParams(extraDate) {
            const params = new URLSearchParams();
            if (extraDate)                          params.set('date',        extraDate);
            if ('{{ county }}')                     params.set('county',      '{{ county }}');
            if ('{{ city }}')                       params.set('city',        '{{ city }}');
            if ('{{ agency_type }}')                params.set('agency_type', '{{ agency_type }}');
            if ('{{ q }}')                          params.set('q',           '{{ q }}');
            return params.toString();
        }

        function render() {
            document.getElementById('cal-title').textContent =
                monthNames[viewMonth] + ' ' + viewYear;

            const grid = document.getElementById('cal-grid');
            grid.innerHTML = '';

            const firstDay = new Date(viewYear, viewMonth, 1).getDay(); // 0=Sun
            const daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate();
            const today = new Date().toISOString().slice(0, 10);

            // Leading blank cells
            for (let i = 0; i < firstDay; i++) {
                grid.insertAdjacentHTML('beforeend', '<div></div>');
            }

            for (let d = 1; d <= daysInMonth; d++) {
                const iso = viewYear + '-' + pad(viewMonth + 1) + '-' + pad(d);
                const hasPost   = datesWithPosts.has(iso);
                const isToday   = iso === today;
                const isSelected = iso === selectedDate;

                let cls = 'relative flex items-center justify-center h-8 w-full rounded-lg text-xs font-medium ';
                if (isSelected) {
                    cls += 'bg-blue-600 text-white font-bold ';
                } else if (hasPost) {
                    cls += 'bg-blue-50 text-blue-700 font-bold cursor-pointer hover:bg-blue-100 ';
                } else if (isToday) {
                    cls += 'text-blue-500 font-bold ';
                } else {
                    cls += 'text-slate-400 ';
                }

                const dotHtml = hasPost && !isSelected
                    ? '<span class="absolute bottom-1 left-1/2 -translate-x-1/2 w-1 h-1 rounded-full bg-blue-400"></span>'
                    : '';

                const cell = document.createElement('div');
                cell.className = cls;
                cell.innerHTML = d + dotHtml;

                if (hasPost) {
                    cell.style.cursor = 'pointer';
                    cell.addEventListener('click', function () {
                        window.location.href = '/?' + buildParams(iso);
                    });
                }

                grid.appendChild(cell);
            }
        }

        document.getElementById('cal-prev').addEventListener('click', function () {
            viewMonth--;
            if (viewMonth < 0) { viewMonth = 11; viewYear--; }
            render();
        });

        document.getElementById('cal-next').addEventListener('click', function () {
            viewMonth++;
            if (viewMonth > 11) { viewMonth = 0; viewYear++; }
            render();
        });

        render();
    })();
    </script>

</body>
</html>
